<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sharing Room - ShareSquare</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <script>
      function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }
      var room_id;
      if (getParameterByName("room_id") == undefined) {
        room_id = (Math.random() + 1).toString(36).substring(2);
        window.location.href = window.location.href + "?room_id=" + room_id;
      } else room_id = getParameterByName("room_id");
    </script>
    <div class="container">
      <div class="col-left">
        <div class="left-box">
          <div class="waiting-area">
            <h2>Waiting for Peer</h2>
            <img
              src="https://thumbs.gfycat.com/MadeupWillingKronosaurus-max-1mb.gif"
            />
          </div>

          <div class="drop-area" style="display: none">
            <p id="drop_zone_text">
              Drag one or more files to this <i>drop zone</i>.<br />
            </p>

            <div
              id="drop_zone"
              ondrop="dropHandler(event);"
              ondragover="dragOverHandler(event);"
            >
              <input type="file" id="fileinput" />
            </div>

            <br />
            <button id="sendFileBtn">send</button>
          </div>

          <div class="stats-area">
            <div class="fileprogress-box">
              <span id="filetransfer-text">Uploading</span>
              <span id="speed"></span> <br />
              <span id="filename-text"></span><br />
              <div class="progress" id="progress">0%</div>

              <div class="progress-bar">
                <div class="progress-bar-fill" style="height: 24px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-right">
        <div class="right-box">
          <p
            style="
              font-size: 40px;
              font-weight: bold;
              text-align: center;
              margin-bottom: 0px;
            "
          >
            ShareSquare
          </p>
          <br />
          Welcome to ShareSquare. <br />Share Large files Securly to Other
          Device
          <br />
          <div class="roomcode-box">
            <p>Room Link:</p>
            <input type="text" name="room_id" id="room_id" />
          </div>

          <form
            action="/sendEmail"
            method="POST"
            id="emailform"
            enctype="multipart/form-data"
            class="emailform"
          >
            <input type="hidden" name="room_id" id="room_id_hidden" />
            <input
              type="email"
              name="email"
              id="email"
              placeholder="Enter Email"
            />
            <input type="submit" value="Send" />
          </form>

          <br />
          <msglist></msglist>
          <br />
          <div class="info-box">
            <div class="info-box-header">
              <h3>Self Info</h3>
              <p><bold>My Peer ID:</bold> <mypeerid></mypeerid></p>
            </div>
            <br />
            <p class="speedlogs"></p>

            PeerList
            <list> </list>
          </div>
        </div>
      </div>
    </div>

    <script>
      function dragOverHandler(ev) {
        console.log("File(s) in drop zone");

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
      }
      function dropHandler(ev) {
        console.log("File(s) dropped");

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
        document.body.style.backgroundColor = "lightgreen";
        document.getElementById("fileinput").value =
          event.dataTransfer.getData("file");
        var filename = ev.dataTransfer.files[0].name;

        $("#drop_zone_text").html(filename + "<br>Start sending file now!");
        $("#sendFileBtn").show();
        $("#fileinput").hide();
      }

      $("document").ready(function () {
        $("#fileinput").change(function () {
          $("#drop_zone_text").html("File Dropped. Start sending file now!");
          $("#sendFileBtn").show();
        });
      });
    </script>

    <script src="https://www.gstatic.com/firebasejs/5.0.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.0.1/firebase-database.js"></script>

    <script>
      const app = firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
    </script>

    <script>
      const peers_list = [];

      var usersRef = database.ref("users/rooms/" + room_id + "/users");
      usersRef.on("value", (snap) => {
        // console.log(snap.val());
        snap.forEach(function (childSnapshot) {
          var childKey = childSnapshot.key;
          var childData = childSnapshot.val();
          console.log(childKey);
          if (!peers_list.includes(childKey) && childKey != mypeerid) {
            $(".waiting-area").hide();
            $(".drop-area").show();
            //new user
            $("list").append('<p id="' + childKey + '">' + childKey + " </p>");
            peers_list.push(childKey);

            connectPeer(childKey);
          }
        });
      });

      usersRef.on("child_removed", (data) => {
        console.log("Removed:" + data.key);
        $("#" + data.key).remove();
      });
    </script>
    <script>
      $("#room_id").val(
        location.origin + location.pathname + "?room_id=" + room_id
      );
      $("#room_id_hidden").val(
        location.origin + location.pathname + "?room_id=" + room_id
      );
    </script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="/static/js/scripts.js"></script>
  </body>
</html>
